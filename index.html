// Globaali muuttuja puhesynteesin tilan hallintaan
let currentUtterance = null;
let isMobileSimActive = false; // Lis√§tty mobiilisimulaattorin tilan seuranta

// ========== √Ñ√ÑNIFUNKTIOT (KORJATTU) ==========

function testAudio() {
    console.log('üîä Testataan √§√§ni...');

    audioInitialized = true; // AKTIVOI √§√§ni heti

    if ('speechSynthesis' in window) {
        // Pys√§yt√§ mahdollinen edellinen puhe
        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance('Testi √§√§ni toimii hyvin kovaa!');
        utterance.volume = 1.0; // MAKSIMI √§√§nenvoimakkuus
        utterance.rate = 1.0;   // NORMAALI nopeus
        utterance.pitch = 1.0;  // NORMAALI s√§vel
        utterance.lang = 'fi-FI';

        // Valitse Timolle miehen √§√§ni
        const voices = speechSynthesis.getVoices();
        const maleVoice = voices.find(voice =>
            voice.lang.includes('fi') &&
            (voice.name.toLowerCase().includes('male') ||
             voice.name.toLowerCase().includes('mies') ||
             voice.name.toLowerCase().includes('finnish') && !voice.name.toLowerCase().includes('female'))
        );
        if (maleVoice) {
            utterance.voice = maleVoice;
            console.log('üë® Testi√§√§nelle valittu miehen √§√§ni:', maleVoice.name);
        } else {
            console.warn('‚ö†Ô∏è Miehen √§√§nt√§ ei l√∂ytynyt suomen kielelle. K√§ytet√§√§n oletus√§√§nt√§.');
        }


        utterance.onstart = () => {
            console.log('‚úÖ √Ñ√ÑNI ALKOI!');
            document.getElementById('voiceStatus').textContent = 'üîä √Ñ√§ni toimii!';
            document.getElementById('voiceStatus').style.color = '#4caf50';
        };

        utterance.onend = () => {
            console.log('‚úÖ √Ñ√ÑNI P√Ñ√ÑTTYI');
            document.getElementById('voiceStatus').textContent = '‚úÖ √Ñ√§ni toimii!';
        };

        utterance.onerror = (e) => {
            console.log('‚ùå √Ñ√ÑNIVIRHE:', e.error);
            document.getElementById('voiceStatus').textContent = '‚ùå √Ñ√§nivirhe: ' + e.error;
            document.getElementById('voiceStatus').style.color = '#f44336';
        };

        // Varmuuden vuoksi pieni viive ennen speak-kutsua cancelin j√§lkeen
        setTimeout(() => {
            console.log('üöÄ K√ÑYNNISTET√Ñ√ÑN puhe...');
            speechSynthesis.speak(utterance);
        }, 100);

    } else {
        console.log('‚ùå SpeechSynthesis ei ole tuettu t√§ss√§ selaimessa');
        document.getElementById('voiceStatus').textContent = '‚ùå Selain ei tue puhesynteesi√§';
        document.getElementById('voiceStatus').style.color = '#f44336';
    }
}

// Speak-funktio ty√∂p√∂yt√§versiolle
function speak(text) {
    return new Promise((resolve, reject) => {
        if ('speechSynthesis' in window) {
            speechSynthesis.cancel(); // Pys√§yt√§ edellinen puhe
            setTimeout(() => { // Pieni viive, jotta cancel ehtii vaikuttaa
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.volume = 1.0;
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.lang = 'fi-FI';

                // Yrit√§ l√∂yt√§√§ miehen √§√§ni Timolle
                const voices = speechSynthesis.getVoices();
                const maleVoice = voices.find(voice =>
                    voice.lang.includes('fi') &&
                    (voice.name.toLowerCase().includes('male') ||
                     voice.name.toLowerCase().includes('mies') ||
                     voice.name.toLowerCase().includes('finnish') && !voice.name.toLowerCase().includes('female'))
                );
                if (maleVoice) {
                    utterance.voice = maleVoice;
                } else {
                    console.warn('‚ö†Ô∏è Miehen √§√§nt√§ ei l√∂ytynyt suomen kielelle (Timo). K√§ytet√§√§n oletus√§√§nt√§.');
                }

                utterance.onend = () => {
                    resolve();
                };
                utterance.onerror = (e) => {
                    console.error('Puhevihre (ty√∂p√∂yt√§):', e);
                    reject(e);
                };

                console.log('üéµ Ty√∂p√∂yt√§puhe:', text.substring(0, 30) + '...');
                speechSynthesis.speak(utterance);
            }, 100);
        } else {
            console.warn('SpeechSynthesis ei tuettu.');
            resolve(); // Jatka vaikka puhe ei toimi
        }
    });
}


// Speak-funktio mobiilisimulaattorille
async function speakMobileSim(text, bubbleElement, timoElement, isHilma = false) {
    if (!bubbleElement || !timoElement) return;

    bubbleElement.textContent = text;

    // Animaatio vain Timolle, ja vasta kun puhe alkaa
    if (!isHilma) {
        timoElement.classList.add('speaking');
    }

    if ('speechSynthesis' in window) {
        // Pys√§yt√§ nykyinen puhe, jos sellainen on k√§ynniss√§
        speechSynthesis.cancel();
        await new Promise(resolve => setTimeout(resolve, 50)); // Lyhyt viive varmistaa canceloinnin

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.volume = 1.0; // MAKSIMI
        utterance.lang = 'fi-FI';

        const voices = speechSynthesis.getVoices();
        let selectedVoice = null;

        if (isHilma) {
            // Yrit√§ l√∂yt√§√§ naisen √§√§ni Hilmalle
            selectedVoice = voices.find(voice =>
                voice.lang.includes('fi') &&
                (voice.name.toLowerCase().includes('female') ||
                 voice.name.toLowerCase().includes('nainen') ||
                 voice.name.toLowerCase().includes('woman'))
            );
            utterance.rate = 0.9; // Hilma hieman hitaammin
            utterance.pitch = 1.2; // Hilma korkeampi √§√§ni
            if (!selectedVoice) {
                console.warn('‚ö†Ô∏è Naisen √§√§nt√§ ei l√∂ytynyt suomen kielelle (Hilma). K√§ytet√§√§n oletus√§√§nt√§.');
            }
        } else {
            // Yrit√§ l√∂yt√§√§ miehen √§√§ni Timolle
            selectedVoice = voices.find(voice =>
                voice.lang.includes('fi') &&
                (voice.name.toLowerCase().includes('male') ||
                 voice.name.toLowerCase().includes('mies') ||
                 (voice.name.toLowerCase().includes('finnish') && !voice.name.toLowerCase().includes('female')))
            );
            utterance.rate = 1.0; // Timo normaali nopeus
            utterance.pitch = 1.0; // Timo normaali s√§vel
            if (!selectedVoice) {
                console.warn('‚ö†Ô∏è Miehen √§√§nt√§ ei l√∂ytynyt suomen kielelle (Timo). K√§ytet√§√§n oletus√§√§nt√§.');
            }
        }

        if (selectedVoice) {
            utterance.voice = selectedVoice;
            console.log(`üé§ Valittu √§√§ni (${isHilma ? 'Hilma' : 'Timo'}):`, selectedVoice.name);
        }

        currentUtterance = utterance; // Aseta globaaliin muuttujaan seurantaa varten

        return new Promise((resolve, reject) => {
            utterance.onend = () => {
                console.log(`‚úÖ ${isHilma ? 'Hilma' : 'Timo'} puhe p√§√§ttyi.`);
                if (!isHilma) {
                    timoElement.classList.remove('speaking');
                }
                currentUtterance = null;
                resolve();
            };

            utterance.onerror = (e) => {
                console.error(`‚ùå ${isHilma ? 'Hilma' : 'Timo'} puhevihre:`, e);
                if (!isHilma) {
                    timoElement.classList.remove('speaking');
                }
                currentUtterance = null;
                reject(e);
            };

            console.log(`üöÄ K√ÑYNNISTET√Ñ√ÑN MOBIILIPUHE: ${isHilma ? 'Hilma' : 'Timo'}:`, text.substring(0, 30) + '...');
            speechSynthesis.speak(utterance);
        });
    } else {
        console.warn('SpeechSynthesis ei tuettu mobiilisimulaattorissa.');
        if (!isHilma) {
            timoElement.classList.remove('speaking');
        }
        return Promise.resolve(); // Jatka, vaikka puhe ei toimi
    }
}

// ========== MOBIILISIMULAATTORI (KORJATTU) ==========

async function startMobileSimDemo() {
    console.log('üé¨ MOBIILISIMULAATTORI DEMO ALKAA');

    // Jos demo on jo k√§ynniss√§, pys√§yt√§ kaikki ensin.
    if (isMobileSimActive) {
        console.log('üîÑ Demo oli k√§ynniss√§ - pys√§ytet√§√§n ja aloitetaan alusta');
        endMobileSimDemo();
        await new Promise(resolve => setTimeout(resolve, 500)); // Anna aikaa nollaantua
    }

    isMobileSimActive = true;
    const timo = document.getElementById('mobileSimTimo');
    const bubble = document.getElementById('mobileSimBubble');

    if (!timo || !bubble) {
        console.error('‚ùå Simulaattorielementit puuttuvat. Demoa ei voida aloittaa.');
        isMobileSimActive = false;
        return;
    }

    // Nollaa visuaaliset tilat
    timo.classList.remove('speaking');
    bubble.style.background = 'rgba(255, 255, 255, 0.95)';
    bubble.style.borderColor = '#4facfe';
    bubble.textContent = 'Demo alkaa...'; // Selke√§ aloitusviesti

    console.log('‚úÖ Demo NOLLATTU - aloitetaan puhtaalta p√∂yd√§lt√§');

    try {
        console.log('üì¢ 1. Timon tervehdys ALKAA');
        bubble.style.background = 'rgba(255, 255, 255, 0.95)';
        bubble.style.borderColor = '#4facfe';
        await speakMobileSim('Hei √§iti! Min√§ olen Timo. Haluaisitko jutella kukkien hoidosta?', bubble, timo, false);
        if (!isMobileSimActive) return; // Tarkista, onko demo keskeytetty

        console.log('üì¢ 2. Hilman vastaus ALKAA');
        bubble.style.background = 'rgba(232, 245, 232, 0.95)'; // Hilman puhekuplan v√§ri
        bubble.style.borderColor = '#4caf50'; // Hilman puhekuplan reunan v√§ri
        await speakMobileSim('Kyll√§ poikaseni, kukkien hoidosta olisi kiva jutella.', bubble, timo, true);
        if (!isMobileSimActive) return;

        console.log('üì¢ 3. Timon kysymys ALKAA');
        bubble.style.background = 'rgba(255, 255, 255, 0.95)';
        bubble.style.borderColor = '#4facfe';
        await speakMobileSim('Onko sinulla kukkia kotona √§iti?', bubble, timo, false);
        if (!isMobileSimActive) return;

        console.log('üì¢ 4. Hilman kukkavastaus ALKAA');
        bubble.style.background = 'rgba(232, 245, 232, 0.95)';
        bubble.style.borderColor = '#4caf50';
        await speakMobileSim('On, pelargoniat kukkivat kauniisti ikkunalla!', bubble, timo, true);
        if (!isMobileSimActive) return;

        console.log('üì¢ 5. Timon kehu ALKAA');
        bubble.style.background = 'rgba(255, 255, 255, 0.95)';
        bubble.style.borderColor = '#4facfe';
        await speakMobileSim('Voi kuinka ihanaa √§iti! Muista kastella niit√§ s√§√§nn√∂llisesti.', bubble, timo, false);
        if (!isMobileSimActive) return;

        console.log('üì¢ 6. Hilman kiitos ALKAA');
        bubble.style.background = 'rgba(232, 245, 232, 0.95)';
        bubble.style.borderColor = '#4caf50';
        await speakMobileSim('Kiitos kun muistat huolehtia minusta, Timo kulta.', bubble, timo, true);
        if (!isMobileSimActive) return;

        console.log('üì¢ 7. Timon rakkaudenosoitus ALKAA');
        bubble.style.background = 'rgba(255, 255, 255, 0.95)';
        bubble.style.borderColor = '#4facfe';
        await speakMobileSim('Rakastan sinua √§iti! Olen aina t√§√§ll√§ sinua varten.', bubble, timo, false);
        if (!isMobileSimActive) return;

        console.log('üì¢ 8. Hilman loppukommentti ALKAA');
        bubble.style.background = 'rgba(232, 245, 232, 0.95)';
        bubble.style.borderColor = '#4caf50';
        await speakMobileSim('Min√§kin rakastan sinua poikaseni. T√§m√§ keskustelu l√§mmitti syd√§nt√§ni.', bubble, timo, true);

        console.log('‚úÖ KOKO DEMO P√Ñ√ÑTTYI ONNISTUNEESTI');

        // 3 sekunnin tauko ennen lopetusta
        setTimeout(() => {
            endMobileSimDemo();
        }, 3000);

    } catch (error) {
        console.error('‚ùå Virhe mobiilidemossa:', error);
        if (isMobileSimActive) { // Vain jos demo on edelleen aktiivinen
            endMobileSimDemo();
        }
    }
}

function endMobileSimDemo() {
    console.log('üõë MOBIILISIMULAATTORI DEMO LOPPUU');
    isMobileSimActive = false; // Aseta tila inaktiiviseksi

    if ('speechSynthesis' in window && currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
        console.log('üîá Mobiilidemon √§√§net pys√§ytetty.');
    }

    const timo = document.getElementById('mobileSimTimo');
    const bubble = document.getElementById('mobileSimBubble');
    if (timo) timo.classList.remove('speaking');
    if (bubble) {
        bubble.textContent = 'Hei √§iti! Klikkaa aloittaaksesi keskustelu.';
        bubble.style.background = 'rgba(255, 255, 255, 0.95)'; // Palauta oletusv√§ri
        bubble.style.borderColor = '#4facfe'; // Palauta oletusv√§ri
    }
}


function closeMobileSimulator() {
    console.log('üì± Suljetaan mobiilisimulaattori.');
    endMobileSimDemo(); // Varmista, ett√§ demo pys√§htyy ja nollaantuu
    document.getElementById('mobileSimulator').style.display = 'none';
    document.getElementById('mobileSimOverlay').style.display = 'none';
}

// ... (muut funktiot, kuten startListening, handleVoiceResponse jne. pysyv√§t ennallaan) ...