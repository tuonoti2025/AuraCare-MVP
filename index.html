
<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>AuraCare MVP ‚Äì Katkeamaton puhe</title>
  <style>
    body { font-family: Arial; background: #f1f8e9; padding: 20px; text-align: center; }
    h1 { color: #33691e; }
    .log { margin-top: 30px; max-width: 600px; margin-left: auto; margin-right: auto;
           background: white; padding: 15px; border-radius: 8px;
           box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: left; }
    .mic-status {
      position: fixed; bottom: 20px; left: 20px;
      background: #ffffffcc; border: 2px solid #aed581;
      padding: 10px 15px; border-radius: 10px;
      font-weight: bold; color: #33691e;
    }
  </style>
</head>
<body>
  <h1>AuraCare MVP ‚Äì Korjattu puhevika</h1>
  <p>Avustaja puhuu ilman katkeamista. Mikrofoni aktivoituu automaattisesti.</p>
  <div class="log" id="log"><h3>Tapahtumat:</h3><ul id="log-list"></ul></div>
  <div class="mic-status" id="micStatus">‚è∏Ô∏è Odottaa...</div>

<script>
const synth = window.speechSynthesis;
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'fi-FI';
let voices = [];
let stage = 0;

function log(text) {
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement("li");
  entry.textContent = time + " ‚Äì " + text;
  document.getElementById("log-list").appendChild(entry);
}
function updateMicStatus(text) {
  document.getElementById("micStatus").textContent = text;
}
function loadVoices(callback) {
  voices = synth.getVoices();
  if (voices.length) callback();
  else setTimeout(() => loadVoices(callback), 100);
}
function speakMulti(text, callback) {
  const parts = text.match(/[^.!?]+[.!?]?/g);
  let i = 0;
  function speakPart() {
    if (i < parts.length) {
      const u = new SpeechSynthesisUtterance(parts[i]);
      u.lang = 'fi-FI';
      u.voice = voices.find(v => v.lang === 'fi-FI' && v.localService) || voices.find(v => v.lang === 'fi-FI');
      u.onend = () => {
        i++;
        speakPart();
      };
      synth.speak(u);
      updateMicStatus("üîà Puhuu...");
    } else {
      updateMicStatus("‚è∏Ô∏è Odottaa...");
      if (callback) callback();
    }
  }
  speakPart();
}
function startListening(delay = 1000) {
  setTimeout(() => {
    recognition.start();
    updateMicStatus("üé§ Kuuntelee...");
  }, delay);
}
function isYes(text) {
  return ["kyll√§", "joo", "ok"].some(word => text.includes(word));
}

recognition.onresult = function(event) {
  const speech = event.results[0][0].transcript.toLowerCase();
  log("K√§ytt√§j√§ sanoi: " + speech);
  recognition.stop();
  updateMicStatus("‚è∏Ô∏è Odottaa...");

  if (stage === 0 && isYes(speech)) {
    speakMulti("Jutellaanko kukista? Sano vaikka kyll√§.", () => {
      stage = 1; startListening();
    });
  } else if (stage === 1 && isYes(speech)) {
    speakMulti("On aika ottaa l√§√§kkeet.", () => {
      stage = 2;
      setTimeout(() => {
        speakMulti("Otitko l√§√§kkeet varmasti?", () => {
          stage = 3; startListening();
        });
      }, 4000);
    });
  } else if (stage === 3 && isYes(speech)) {
    speakMulti("Hienoa. Hyv√§ ett√§ huolehdit l√§√§kkeist√§si.");
    stage = 4;
  } else {
    speakMulti("Voit vastata kyll√§, joo tai ok.", () => {
      startListening();
    });
  }
};
recognition.onerror = function(event) {
  log("Virhe: " + event.error);
  recognition.stop();
  updateMicStatus("‚è∏Ô∏è Odottaa...");
  startListening();
};

window.onload = () => {
  loadVoices(() => {
    setTimeout(() => {
      speakMulti("Terve. Haluatko jutella?", () => {
        stage = 0;
        startListening();
      });
    }, 3000);
  });
};
</script>
</body>
</html>
